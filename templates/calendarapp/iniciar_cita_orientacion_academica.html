{% extends 'base/base.html' %}
{% load static %}

{% comment %} agregado {% endcomment %}
{% block head_list %}

{% endblock %}

{% block title %}Iniciar Cita Orientación Académica{% endblock title %}

{% block breadcrumb %}
{% endblock breadcrumb %}

{% block content %}

<form method="post" id="ori_academ">
    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title">
                {% if action == 'iniciar' %}
                <i class="bi bi-caret-right-square"></i>
                {% endif %}
                {{ title }}
            </h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-7">
                    <div class="card card-secondary">
                        <div class="card-header">
                            <h3 class="card-title"><i class="bi bi-calendar4-event"></i> Datos de la Cita</h3>
                        </div>
                        <div class="card-body">
                            <input type="hidden" name="action" value="{{ action }}">
                            <div class="form-group">
                                <label class="label" for="id_facultad">Facultad</label>
                                {{ form.id_facultad}}
                                <span class="text-danger">{{ form.errors.id_facultad }}</span>
                            </div>
                            <div class="form-group">
                                <label class="label" for="id_funcionario_docente_encargado">Funcionario</label>
                                {{ form.id_funcionario_docente_encargado }}
                                <span class="text-danger">{{ form.errors.id_funcionario_docente_encargado }}</span>
                            </div>
                            <div class="form-group">
                                <label class="label" for="motivo">Motivo</label>
                                <textarea placeholder= "Describa el motivo de la cita..." class="form-control" rows="4" cols="50" name="motivo" required="True" maxlength="500"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="label" for="hora_inicio">Hora de inicio</label> <label> (Cambiar según sea necesario)</label> 
                                <div class="input-group">
                                    <input type="time" class="form-control add-space" id="hora_inicio" name="hora_inicio">
                                    <a href="#" id="ahora_inicio">  Ahora </a>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="label" for="hora_fin">Hora de fin</label> <label> (Cambiar según sea necesario)</label> 
                                <div class="input-group">
                                    <input type="time" class="form-control add-space" id="hora_fin" name="hora_fin">
                                    <a href="#" id="ahora_fin">  Ahora </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="card card-secondary">
                        <div class="card-header">
                            <h3 class="card-title"><i class="bi bi-people"></i> Participantes adicionales</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Buscador de participantes:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" name="search"
                                           placeholder="Ingrese número de cédula del participante..." autocomplete="off">
                                    <span class="input-group-append">
                                    <button type="button" class="btn btn-danger btn-flat btnClearSearch" title="Cancelar"><i class="bi bi-x-lg"></i></button>
                                  </span>
                                </div>
                            </div>
                            <hr>
                            <button type="button" class="btn btn-danger btn-xs btn-flat btnRemoveAll">
                                <i class="bi bi-trash2"></i> Eliminar todos los participantes
                            </button>
                            <hr>
                            <table class="table table-bordered" id="tblParticipantes">
                                <thead>
                                <tr>
                                    <th>Opción</th>
                                    <th>Participante</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-7">
                    <div class="card card-secondary">
                        <div class="card-header">
                            <h3 class="card-title"><i class="bi bi-person-rolodex"></i> Datos de la Orientación Académica</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="label" for="id_tipo_orientacion_academica">Tipo de Orientación Académica</label>
                                <div class="input-group">
                                    <select name="id_tipo_orientacion_academica" class="form-control select2 select2-hidden-accessible" style="width: 100%" id="id_id_tipo_orientacion_academica" data-select2-id="id_id_tipo_orientacion_academica" tabindex="-1" aria-hidden="true"></select>
                                    {% if perms.calendarapp.add_tipoorientacionacademica %} 
                                        <a href="#" id="add_tipo_orientacion" title="Agregar nuevo tipo.">  <i class="bi bi-plus"></i> </a>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="label" for="id_tipo_motivo">Motivo de Orientación Académica</label>
                                <div class="input-group">
                                    <select name="id_tipo_motivo" class="form-control select2 select2-hidden-accessible" style="width: 100%" id="id_id_tipo_motivo" data-select2-id="id_id_tipo_motivo" tabindex="-1" aria-hidden="true"></select>
                                    {% if perms.calendarapp.add_motivo %} 
                                        <a href="#" id="add_motivo" title="Agregar nuevo motivo.">  <i class="bi bi-plus"></i> </a>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="label" for="id_materia">Materia</label>
                                {{ form.id_materia}}
                                <span class="text-danger">{{ form.errors.id_materia }}</span>
                            </div>
                            <div class="form-group">
                                <label class="label" for="nro_curso">Nro. Curso</label>
                                <div class="input-group">
                                    {{ form.nro_curso }}
                                    <span class="text-danger">{{ form.errors.motivo }}</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="label" for="observacion">Observación</label>
                                <textarea placeholder= "Desea agregar algún comentario adicional?..." class="form-control" rows="4" cols="50" name="observacion" maxlength="500"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-12">
                    <div class="card card-secondary">
                        <div class="card-header">
                            <h3 class="card-title"><i class="bi bi-journal-text"></i> Tareas</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <div class="tile">
                                    <div>
                                        <button type="button" class="btn btn-primary btn-flat btnRegistrarTarea" title="Añadir Taarea">
                                            <i class="bi bi-plus-lg"></i> Agregar Tarea
                                        </button>
                                        <button type="button" class="btn btn-danger btn-xs btn-flat btnRemoveAllTareas">
                                            <i class="bi bi-trash2"></i> Eliminar todas las tareas
                                        </button>
                                    </div>
                                    <br>

                                    <div class="tile-body">
                                        <div class="table-responsive">
                                            <div class="dataTables_wrapper container-fluid dt-bootstrap4 no-footer">
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <table class="table table-hover table-bordered dataTable no-footer" id="tblTareas" role="grid" aria-describedby="sampleTable_info">
                                                            <thead>
                                                                <tr role="row">
                                                                    <th>Inicio</th>
                                                                    <th>Vencimiento</th>
                                                                    <th>Responsable</th>
                                                                    <th>Tipo Tarea</th>
                                                                    <th>Estado</th>
                                                                    <th>Observación</th>
                                                                    <th>Opción</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>

        <div class="card-footer">
            <button type="submit" class="btn btn-primary btn-flat">
                <i class="bi bi-calendar-check"></i> Finalizar cita
            </button> 
            <button type="button" class="btn btn-danger btn-flat btnCancelar" title="Cancelar"> <i class="bi bi-calendar-x"></i> Cancelar</button>
    
        </div>
    </div>

    <div id="modaltareas" class="modal fade show" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div id="dialog" class="modal-dialog modal-dialog-centered" role="document"> 
            <div class="modal-content">
                <div class='modal-header text-center'>
                    <h3 class="modal-title w-100"> Crear Tarea</h3> 
                    <button id="modalClose2" type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
    
                <div class="modal-body">
                    <div class="container">
                        <div class="form-group">
                            <label class="label" for="hora_inicio_tarea">Inicio</label> 
                                <input type="datetime-local" class="form-control" id="hora_inicio_tarea" name="hora_inicio_tarea">
                                <a href="#" id="ahora_inicio_tarea">  Ahora </a>
                        </div>
        
                        <div class="form-group">
                            <label class="label" for="hora_fin_tarea">Fin</label>
                                <input type="datetime-local" class="form-control" id="hora_fin_tarea" name="hora_fin_tarea">
                                <a href="#" id="ahora_fin_tarea">  Ahora </a>
                        </div>
                    
                        <div class="form-group">
                            <label class="label" for="id_responsable_tarea">Responsable</label>
                            <select name="id_responsable_tarea" class="form-control select2 select2-hidden-accessible" style="width: 100%" id="id_id_responsable_tarea" data-select2-id="id_id_responsable_tarea" tabindex="-1" aria-hidden="true"></select>
                        </div>

                        <div class="form-group">
                            <label class="label" for="id_tipo_tarea">Tipo de Tarea</label>
                            <select name="id_tipo_tarea" class="form-control select2 select2-hidden-accessible" style="width: 100%" id="id_id_tipo_tarea" data-select2-id="id_id_tipo_tarea" tabindex="-1" aria-hidden="true"></select>
                        </div>

                        <div class="form-group">
                            <label class="label" for="id_tipo_tarea">Estado de Tarea</label>
                            <select name="id_estado_tarea" class="form-control select2 select2-hidden-accessible" style="width: 100%" id="id_id_estado_tarea" data-select2-id="id_id_estado_tarea" tabindex="-1" aria-hidden="true"></select>
                        </div>
            
                        <div class="form-group">
                            <label class="label" for="observacion_tarea">Observación</label>
                            <textarea placeholder= "Desea agregar algún comentario adicional?..." class="form-control" rows="3" cols="25" name="observacion_tarea" maxlength="500"></textarea>
                        </div>
                    
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal" id="modalClose1"> Cancelar</button>
                            <button type="button" class="btn btn-primary" id="modalguardar"> Guardar</button>
                        </div>  

                    </div>       
                </div>  
            </div>
        </div>
    </div>


    
    <div id="modalAddTipoOrientacion" class="modal fade show" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div id="dialog" class="modal-dialog modal-dialog-centered" role="document"> 
            <div class="modal-content">
                <div class='modal-header text-center'>
                    <h3 class="modal-title w-100"> Agregar Tipo Orientación Académica</h3> 
                    <button id="cerrarAddtipoOrientacion1" type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
    
                <div class="modal-body">
                    <div class="container">
                        <div class="form-group">
                            <label class="label" for="descripcion_tipo_orientacion">Tipo de Orientación Académica:</label>
                            <textarea placeholder= "Descripcion para el tipo de orientación académica..." class="form-control" rows="3" cols="25" name="descripcion_tipo_orientacion" maxlength="500"></textarea>
                        </div>
                    
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cerrarAddtipoOrientacion2"> Cancelar</button>
                            <button type="button" class="btn btn-primary" id="guardarTipoOrientacion"> Guardar</button>
                        </div>  

                    </div>       
                </div>  
            </div>
        </div>
    </div>


    <div id="modalAddMotivo" class="modal fade show" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div id="dialog" class="modal-dialog modal-dialog-centered" role="document"> 
            <div class="modal-content">
                <div class='modal-header text-center'>
                    <h3 class="modal-title w-100"> Agregar Motivo de Orientación Académica</h3> 
                    <button id="cerrarMotivo1" type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
    
                <div class="modal-body">
                    <div class="container">
                        <div class="form-group">
                            <label class="label" for="id_tipo_orientacion_academica">Tipo de Orientación Académica</label>
                            <div class="input-group">
                                <select name="id_tipo_orientacion_academica_add" class="form-control select2 select2-hidden-accessible" style="width: 100%" id="id_id_tipo_orientacion_academica_add" data-select2-id="id_id_tipo_orientacion_academica_add" tabindex="-1" aria-hidden="true"></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="label" for="descripcion_Motivo">Motivo de Orientación Académica:</label>
                            <textarea placeholder= "Descripcion para el Motivo de orientación académica..." class="form-control" rows="3" cols="25" name="descripcion_Motivo" maxlength="500"></textarea>
                        </div>
                    
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cerrarMotivo2"> Cancelar</button>
                            <button type="button" class="btn btn-primary" id="guardarMotivo"> Guardar</button>
                        </div>  

                    </div>       
                </div>  
            </div>
        </div>
    </div>


</form>

{% endblock content %}

{% block extrascripts %}
    <script type="text/javascript" src="{% static 'js/plugins/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/plugins/dataTables.bootstrap.min.js' %}"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link href="{% static 'lib_extras/jquery-ui-1.12.1/jquery-ui.min.css' %}" rel="stylesheet"/>
    <script src="{% static 'lib_extras/jquery-ui-1.12.1/jquery-ui.min.js' %}"></script>

    <link href="{% static 'lib_extras/select2-4.0.13/css/select2.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'lib_extras/select2-4.0.13/css/select2-bootstrap4.min.css' %}" rel="stylesheet"/>
    <script src="{% static 'lib_extras/select2-4.0.13/js/select2.min.js' %}"></script>
    <script src="{% static 'lib_extras/select2-4.0.13/js/i18n/es.js' %}"></script>

    <link rel="stylesheet" href="{% static 'lib_extras/datatables-1.10.20/css/dataTables.bootstrap4.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'lib_extras/datatables-1.10.20/plugins/responsive-2.2.3/css/responsive.bootstrap4.min.css' %}"/>
    <script src="{% static 'lib_extras/datatables-1.10.20/js/jquery.dataTables.js' %}"></script>
    <script src="{% static 'lib_extras/datatables-1.10.20/js/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'lib_extras/datatables-1.10.20/plugins/responsive-2.2.3/js/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'lib_extras/datatables-1.10.20/plugins/responsive-2.2.3/js/responsive.bootstrap4.min.js' %}"></script>

    <!-- Jquery Confirm -->
    <link rel="stylesheet" href="{% static 'lib_extras/jquery-confirm-v3.3.4/jquery-confirm.min.css' %}">
    <script src="{% static 'lib_extras/jquery-confirm-v3.3.4/jquery-confirm.min.js' %}"></script>
    <!-- Functions -->
    <script src="{% static 'js/functions.js' %}"></script>

    <script>       

        // Obtén una referencia al enlace y al elemento input

        var ahoraInicioLinkTarea = document.getElementById("ahora_inicio_tarea");
        var horaInicioInputTarea = document.getElementById("hora_inicio_tarea");
        var ahoraFinLinkTarea = document.getElementById("ahora_fin_tarea");
        var horaFinInputTarea = document.getElementById("hora_fin_tarea");

        var modal = document.getElementById('modaltareas')
        const cerrarmodal = document.getElementById('modalClose1');
        const cerrarmodal2 = document.getElementById('modalClose2');
        const guardarmodal = document.getElementById('modalguardar');
        var tblTareas;


        var add_orientacion= document.getElementById("add_tipo_orientacion");
        var modalAddTipoOrientacion = document.getElementById('modalAddTipoOrientacion')
        const cerrarAddtipoOrientacion1 = document.getElementById('cerrarAddtipoOrientacion1');
        const cerrarAddtipoOrientacion2 = document.getElementById('cerrarAddtipoOrientacion2');
        const guardarTipoOrientacion = document.getElementById('guardarTipoOrientacion');


        var add_Motivo= document.getElementById("add_Motivo");
        var modalAddMotivo = document.getElementById('modalAddMotivo')
        const cerrarMotivo1 = document.getElementById('cerrarMotivo1');
        const cerrarMotivo2 = document.getElementById('cerrarMotivo2');
        const guardarMotivo = document.getElementById('guardarMotivo');

        var band_boton_selects= 0
        var mi_form= $('#ori_academ')
        var tblParticipantes;
        var lista_participantes = {{ det|safe }}
        var lista_cita = {{ cita|safe }}

        var actividad_academica = {
            items: {
                id_facultad: '',
                id_materia: '',
                id_funcionario_docente_encargado: '',
                motivo: '',
                nro_curso: '',
                participantes: [],
                tareas: [],
                datetime_inicio_real: '',
                datetime_fin_real: '',
                observacion: '',
                id_tipo_orientacion_academica: '',
                id_motivo_ori_academ: ''
            },

            add: function (item) {
                this.items.participantes.push(item);
                this.list();
            },
            verificar_participante: function (valor) {
                var encontrado= false;
                for (var i = 0; i < this.items.participantes.length; i++) {
                    if (this.items.participantes[i]["id"] === valor) {
                      encontrado = true;
                      break;
                    }
                }

                  if (encontrado) {
                    return true;
                  } else {
                    return false;
                  }
            },
            list: function () {

                tblParticipantes = $('#tblParticipantes').DataTable({
                    searching: false,
                    paging: false,
                    responsive: true,
                    autoWidth: false,
                    destroy: true,
                    data: this.items.participantes,
                    columns: [
                        {"data": "id"},
                        {"data": "value"},
                    ],
                    columnDefs: [
                        {
                            targets: [0],
                            class: 'text-center',
                            orderable: false,
                            render: function (data, type, row) {
                                return '<a rel="remove" class="btn btn-danger btn-xs btn-flat" style="color: white;"><i class="bi bi-dash"></i></a>';
                            }
                        },
                    ]

                });
                
                tblTareas = $('#tblTareas').DataTable({
                    searching: true,
                    paging: true,
                    responsive: true,
                    autoWidth: false,
                    destroy: true,
                    data: this.items.tareas,
                    columns: [
                        {"data": "inicio"},
                        {"data": "vencimiento"},
                        {"data": "responsable"},
                        {"data": "tipo_tarea"},
                        {"data": "estado"},
                        {"data": "observacion"},
                        {},
                    ],
                    columnDefs: [
                        {
                            targets: [0],
                            class: 'text-center',
                            orderable: true,
                            render: function (data, type, row) {
                                var fechainicio = new Date(data);
                                var dia = fechainicio.getDate().toString().padStart(2, '0');
                                var mes = (fechainicio.getMonth() + 1).toString().padStart(2, '0');
                                var anho = fechainicio.getFullYear().toString();
                                var horas = fechainicio.getHours().toString().padStart(2, '0');
                                var minutos = fechainicio.getMinutes().toString().padStart(2, '0');
                                var segundos = fechainicio.getSeconds().toString().padStart(2, '0');
                                
                                var fechaInicioFormateada = dia + '-' + mes + '-' + anho + ' ' + horas + ':' + minutos + ':' + segundos;
                                
                                return '<text name="InicioTarea" value="' + data + '">' + fechaInicioFormateada + '</text>';
                            }
                        },
                        {
                            targets: [1],
                            class: 'text-center',
                            orderable: true,
                            render: function (data, type, row) {
                                var fechafin = new Date(data);
                                var dia = fechafin.getDate().toString().padStart(2, '0');
                                var mes = (fechafin.getMonth() + 1).toString().padStart(2, '0');
                                var anho = fechafin.getFullYear().toString();
                                var horas = fechafin.getHours().toString().padStart(2, '0');
                                var minutos = fechafin.getMinutes().toString().padStart(2, '0');
                                var segundos = fechafin.getSeconds().toString().padStart(2, '0');
                                
                                var fechaFinFormateada = dia + '-' + mes + '-' + anho + ' ' + horas + ':' + minutos + ':' + segundos;
                                
                                return '<text name="FinTarea" value="' + data + '">' + fechaFinFormateada + '</text>';
                            }
                        },
                        {
                            targets: [2],
                            class: 'text-center',
                            orderable: true,
                            render: function (data, type, row) {
                                var inicio = data;
                                var datos = inicio.split('|');
                                var responsable = datos[0]; 
                                var id_responsable = datos[1]; 
                                return '<text name="ResponsalbeTarea" value="' + id_responsable + '">' + responsable + '</text>';
                            }
                        },
                        {
                            targets: [3],
                            class: 'text-center',
                            orderable: true,
                            render: function (data, type, row) {
                                var tipo = data;
                                var datos = tipo.split('|');
                                var tipo_tarea = datos[0]; 
                                var id_tarea = datos[1]; 
                                return '<text name="TipoTarea" value="' + id_tarea +'">' + tipo_tarea + '</text>';
                            }
                        },
                        {
                            targets: [4],
                            class: 'text-center',
                            orderable: true,
                            render: function (data, type, row) {
                                var estado = data;
                                var datos = estado.split('|');
                                var estado_tarea = datos[0]; 
                                var id_estado_tarea = datos[1]; 
                                return '<text name="EstadoTarea" value="' + id_estado_tarea + '">' + estado_tarea + '</text>';
                            }
                        },
                        {
                            targets: [5],
                            class: 'text-center',
                            orderable: true,
                            render: function (data, type, row) {
                                return '<text name="Observacion" value="'+ data +'">' + data + '</text>';
                            }
                        },
                        {
                            targets: [-1],
                            class: 'text-center',
                            orderable: false,
                            render: function (data, type, row) {
                                return '<a rel="removetarea" class="btn btn-danger btn-xs btn-flat" style="color: white;"><i class="bi bi-dash"></i></a>';
                            }
                        },
                    ]

                });
            },
            addtarea: function (item) {
                this.items.tareas.push(item);
                this.list();
            },
            verificar_tarea: function (valor) {
                var tareaExistente = this.items.tareas.some(function(tarea) {
                    return JSON.stringify(tarea) === JSON.stringify(valor);
                  });
                  
                  if (tareaExistente) {
                    return false; //La tarea ya existe en el arreglo de tareas.
                  } else {
                    return true; //La tarea es nueva y puede ser agregada.
                  }
            },
            
            actualizar_participantes: function (lista_participantes) {
                
                //Iteramos uno a uno
                for (var i = 0; i < lista_participantes.length; i++) {
                    var newItem = lista_participantes[i]
                    this.items.participantes.push(newItem);
                }
                this.list();
            }            
        };

        $(document).ready(function() {

            //cargamos el campo de motivo
            $('textarea[name="motivo"]').val(lista_cita[0]['motivo']);

            //funcion para crear tabla vacia de tareas
            function reiniciar_tblTareas() {
                // generar tabla de tareas 
                tblTareas = $('#tblTareas').DataTable({
                    searching: true,
                    paging: true,
                    responsive: true,
                    autoWidth: false,
                    destroy: true,
                    columns: [
                        {"data": "inicio"},
                        {"data": "vencimiento"},
                        {"data": "responsable"},
                        {"data": "tipo_tarea"},
                        {"data": "estado"},
                        {"data": "observacion"},
                        {},
                    ],
                    data: [] // Datos vacíos para crear una tabla sin contenido
                });
            }

            // Agrega un evento de clic al enlace
            ahoraInicioLinkTarea.addEventListener("click", function(event) {
                event.preventDefault();  // Evita el comportamiento predeterminado del enlace
                
                // Obtiene la fecha y hora actual en formato 24h
                var now = new Date();
                var fechaHoraActual = now.getFullYear() + "-" +
                ("0" + (now.getMonth() + 1)).slice(-2) + "-" +
                ("0" + now.getDate()).slice(-2) + "T" +
                ("0" + now.getHours()).slice(-2) + ":" +
                ("0" + now.getMinutes()).slice(-2);

                // Actualiza el valor del input con la fecha y hora actual
                horaInicioInputTarea.value = fechaHoraActual;
            });
            ahoraFinLinkTarea.addEventListener("click", function(event) {
                event.preventDefault();  // Evita el comportamiento predeterminado del enlace
                
                // Obtiene la fecha y hora actual en formato 24h
                var now = new Date();
                var fechaHoraActual = now.getFullYear() + "-" +
                ("0" + (now.getMonth() + 1)).slice(-2) + "-" +
                ("0" + now.getDate()).slice(-2) + "T" +
                ("0" + now.getHours()).slice(-2) + ":" +
                ("0" + now.getMinutes()).slice(-2);

                // Actualiza el valor del input con la fecha y hora actual
                horaFinInputTarea.value = fechaHoraActual;
            });

            //cuando se cargue la pagina traer todas las facultades
            actualizarfacultad();
            actualizarfuncionariodocente();
            actualizartipo_ori_academ();
            cambiarValorHora();
            actualizarmateria();

            function actualizar_personas() {
                $.ajax({
                    url: '/actualizar_campo/',
                    data: {
                        'campo': 'personas'
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#id_id_responsable_tarea').html(data);
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        var errorMessage = 'Ocurrió un error al actualizar personas.';
                        alert(errorMessage + ' ' + textStatus + ': ' + errorThrown);
                    }
                });
            }

            function actualizar_tipo_tarea() {
                $.ajax({
                    url: '/actualizar_campo/',
                    data: {
                        'campo': 'tipo_tareas'
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#id_id_tipo_tarea').html(data);
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        var errorMessage = 'Ocurrió un error al actualizar tipo tarea.';
                        alert(errorMessage + ' ' + textStatus + ': ' + errorThrown);
                    }
                });
            }

            function actualizar_estado_tarea() {
                $.ajax({
                    url: '/actualizar_campo/',
                    data: {
                        'campo': 'estado_tareas'
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#id_id_estado_tarea').html(data);
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        var errorMessage = 'Ocurrió un error al actualizar estado tarea.';
                        alert(errorMessage + ' ' + textStatus + ': ' + errorThrown);
                    }
                });
            }


            function cambiarValorHora() {
                // Obtener el elemento input
                var inicio = document.getElementById('hora_inicio');
                var fin = document.getElementById('hora_fin');
            
                // Cambiar el valor del input
                inicio.value = lista_cita[0]['hora_inicio'];
                fin.value = lista_cita[0]['hora_fin'];
              }


            function actualizartipo_ori_academ() {
                $.ajax({
                    url: '/actualizar_campo/',
                    data: {
                        'campo': 'tipo_ori_academ'
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#id_id_tipo_orientacion_academica').html(data);
                        $('#id_id_tipo_orientacion_academica_add').html(data);
                        actualizartipo_motivo_ori_academ();
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        var errorMessage = 'Ocurrió un error al actualizar tipo orientacion.';
                        alert(errorMessage + ' ' + textStatus + ': ' + errorThrown);
                    }
                });
            }

            function actualizartipo_motivo_ori_academ() {
                var selected_option = $('#id_id_tipo_orientacion_academica').val();
                $.ajax({
                    url: '/actualizar_campo/',
                    data: {
                        'campo': 'motivo_ori_academ',
                        'selected_option': selected_option
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#id_id_tipo_motivo').html(data);
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        var errorMessage = 'Ocurrió un error al actualizar motivo orientacion.';
                        alert(errorMessage + ' ' + textStatus + ': ' + errorThrown);
                    }
                });
            }

            //actualizar motivo cuando cambie el tipo ori academica
            $('#id_id_tipo_orientacion_academica').change(function() {
                actualizartipo_motivo_ori_academ()
            });

            function actualizarfacultad() {
                $.ajax({
                    url: '/actualizar_campo/',
                    data: {
                        'campo': 'facultad_funcionario'
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#id_id_facultad').html(data);
                        //ponemos los valores ya cargados en los selects, solo si es la primera vez
                        if (band_boton_selects == 0){
                            $('#id_id_facultad').val(lista_cita[0]['id_facultad']);
                        }
                        band_boton_selects= band_boton_selects + 1
                        //actualizarmateria();
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        var errorMessage = 'Ocurrió un error al actualizar facultad.';
                        alert(errorMessage + ' ' + textStatus + ': ' + errorThrown);
                    }
                });
            }

             //actualizar el campo de las materias
            function actualizarmateria() {
                $.ajax({
                    url: '/actualizar_campo/',
                    data: {
                        'campo': 'materias'
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#id_id_materia').html(data);
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        var errorMessage = 'Ocurrió un error al actualizar materia.';
                        alert(errorMessage + ' ' + textStatus + ': ' + errorThrown);
                    }

                });
            }
            //ejecutar si cambia la facultad para actualizar materia y func/doc
            //$('#id_id_facultad').change(function() {
                //actualizarmateria()
            //    actualizarfuncionariodocente()
            //});

            //actualizar el campo de la docente/funcionario de acuerdo a la materia seleccionada
            function actualizarfuncionariodocente() {
                //var selected_option = $('#id_id_facultad').val();
                $.ajax({
                    url: '/actualizar_campo/',
                    data: {
                        //'id_facultad': selected_option,
                        'campo': 'funcionariodocente_logeado'
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#id_id_funcionario_docente_encargado').html(data);
                        //ponemos los valores ya cargados en los selects, solo si es la primera vez
                        if (band_boton_selects == 1) {
                            $('#id_id_funcionario_docente_encargado').val(lista_cita[0]['id_funcionario_docente_encargado']);

                            //actualizamos una vez se haya cargado los primeros datos para no alterar la carga de datos
                            actualizar_personas();
                            actualizar_tipo_tarea();
                            actualizar_estado_tarea();
                        }
                        band_boton_selects= band_boton_selects + 1
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        var errorMessage = 'Ocurrió un error al actualizar funcionario.';
                        alert(errorMessage + ' ' + textStatus + ': ' + errorThrown);
                    }
                });
            }

            //ejecutar si cambia la materia para actualiar fun/doc
            //$('#id_id_materia').change(function() {
            //    actualizarfuncionariodocente()
            //});

            //aplicar formato select2 a todos los dropdowns
            $('.select2').select2({
                theme: "bootstrap4",
                language: 'es'
            });


            // search participantes
            $('input[name="search"]').autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: window.location.pathname,
                        type: 'POST',
                        data: {
                            'action': 'search_participantes',
                            'term': request.term
                        },
                        dataType: 'json',
                    }).done(function (data) {
                        response(data);
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        //alert(textStatus + ': ' + errorThrown);
                    }).always(function (data) {

                    });
                },
                delay: 500,
                minLength: 1,
                select: function (event, ui) {
                    event.preventDefault();
                    //console.clear();
                    var validar;
                    validar= actividad_academica.verificar_participante(ui.item["id"])
                    if (validar) {
                        $.alert({
                            title: 'Alerta!',
                            content: 'El participante ya fue agregado en la lista!',
                        });
                    }
                    else{
                        actividad_academica.add(ui.item);
                        $(this).val('');
                    }
                }
            });

            // Obtener el elemento del enlace y el input
            const ahoraFinLink = document.getElementById('ahora_fin');
            const ahoraInicioLink = document.getElementById('ahora_inicio');
            const horaFinInput = document.getElementById('hora_fin');
            const horaInicioInput = document.getElementById('hora_inicio');

            // Agregar un evento al hacer clic en el enlace "Ahora fin"
            ahoraFinLink.addEventListener('click', () => {
                event.preventDefault(); // Previene el comportamiento predeterminado del enlace
                // Obtener la hora actual
                var now = new Date();
                var horaActual = now.getHours().toString().padStart(2, '0');
                var minutoActual = now.getMinutes().toString().padStart(2, '0');

                // Formatear la hora actual
                var horaActualFormateada = `${horaActual}:${minutoActual}`;

                // Actualizar el valor del input con la hora actual
                horaFinInput.value = horaActualFormateada;
            });

             // Agregar un evento al hacer clic en el enlace "Ahora inicio"
             ahoraInicioLink.addEventListener('click', () => {
                event.preventDefault(); // Previene el comportamiento predeterminado del enlace
                // Obtener la hora actual
                var now = new Date();
                var horaActual = now.getHours().toString().padStart(2, '0');
                var minutoActual = now.getMinutes().toString().padStart(2, '0');

                // Formatear la hora actual
                var horaActualFormateada = `${horaActual}:${minutoActual}`;

                // Actualizar el valor del input con la hora actual
                horaInicioInput.value = horaActualFormateada;
            });


            //elimina todos los participantes
            $('.btnRemoveAll').on('click', function () {
                if (actividad_academica.items.participantes.length === 0) return false;
                alert_action('Notificación', '¿Estas seguro de eliminar todos los participantes?', function () {
                    actividad_academica.items.participantes = [];
                    actividad_academica.list();
                });
            });

            //elimina todas las tareas
            $('.btnRemoveAllTareas').on('click', function () {
                if (actividad_academica.items.tareas.length === 0) return false;
                alert_action('Notificación', '¿Estás seguro de eliminar todas las tareas?', function () {
                    actividad_academica.items.tareas = [];
                    actividad_academica.list();
                });
            });

            //eliminar por item de participante
            $('#tblParticipantes tbody')
                .on('click', 'a[rel="remove"]', function () {
                    var tr = tblParticipantes.cell($(this).closest('td, li')).index();
                    alert_action('Notificación', '¿Estas seguro de eliminar el participante?', function () {
                        actividad_academica.items.participantes.splice(tr.row, 1);
                        actividad_academica.list();
                    });
                })

            //eliminar por item de tarea
            $('#tblTareas tbody')
                .on('click', 'a[rel="removetarea"]', function () {
                    var tr = tblTareas.cell($(this).closest('td, li')).index();
                    alert_action('Notificación', '¿Estas seguro de eliminar la tarea?', function () {
                        actividad_academica.items.tareas.splice(tr.row, 1);
                        actividad_academica.list();
                    });
                })

            //actualizar las busqueda de CI
            $('.btnClearSearch').on('click', function () {
                $('input[name="search"]').val('').focus();
            });
            

            // Cita submit, asignacion de atributos para enviar
            $('form').on('submit', function (e) {

                e.preventDefault();                
                //primero debemos validar que los campo obligatorios esten cargados 
                //capturamos el valor de las horas
                var inputInicio = document.getElementById('hora_inicio').value;
                var inputFin = document.getElementById('hora_fin').value;

                // Convertir las cadenas de texto en objetos Date usados para comparar los horario
                var horaInicio = new Date("1970-01-01T" + inputInicio + ":00");
                var horaFin = new Date("1970-01-01T" + inputFin + ":00");

                // Obtener los componentes de la fecha actual
                var fechaActual = new Date();
                var anio = fechaActual.getFullYear();
                var mes = String(fechaActual.getMonth() + 1).padStart(2, '0'); // Se suma 1 al mes porque los meses en JavaScript son base 0
                var dia = String(fechaActual.getDate()).padStart(2, '0');
                var seg = ':00';
                
                //usados para guardar en la BD
                var fechaFinalInicio = `${anio}-${mes}-${dia} ${inputInicio}${seg}`;
                var fechaFinalFin = `${anio}-${mes}-${dia} ${inputFin}${seg}`;

                // Comparar las horas
                if (horaFin <= horaInicio) {
                    $.alert({
                        title: 'Alerta!',
                        content: 'La hora de fin debe ser mayor que la hora de inicio.',
                    });

                } else {

                    //seleccionamos los datos del formulario
                    actividad_academica.items.id_facultad = $('select[name="id_facultad"]').val();
                    actividad_academica.items.id_materia = $('select[name="id_materia"]').val();
                    actividad_academica.items.id_funcionario_docente_encargado = $('select[name="id_funcionario_docente_encargado"]').val();
                    actividad_academica.items.motivo = $('textarea[name="motivo"]').val();
                    actividad_academica.items.nro_curso = $('input[name="nro_curso"]').val();
                    actividad_academica.items.observacion = $('textarea[name="observacion"]').val();
                    
                    //datos de orientacion academica
                    actividad_academica.items.id_motivo_ori_academ = $('select[name="id_tipo_motivo"]').val();
                    actividad_academica.items.id_tipo_orientacion_academica = $('select[name="id_tipo_orientacion_academica"]').val();
                    actividad_academica.items.datetime_inicio_real = fechaFinalInicio;
                    actividad_academica.items.datetime_fin_real = fechaFinalFin;

                    //reasignamos los datos de las tareas de la tabla 
                    actividad_academica.items.tareas= capturar_tareas();

                    var parameters = new FormData();
                    parameters.append('action', $('input[name="action"]').val());
                    parameters.append('actividad_academica', JSON.stringify(actividad_academica.items));
                    submit_with_ajax(window.location.pathname, 'Notificación', '¿Estás seguro de finalizar la cita?', parameters, function () {
                        location.href = '/running-event-list/OriAcademica/';
                    });
                    
                }
            });

            //boton de cancelar
            $('.btnCancelar').on('click', function () {
                alert_action('Notificación', '¿Estas seguro de cancelar el proceso?', function () {
                    window.location.href= '/running-event-list/OriAcademica/'
                });
            });

            //boton de agregar tarea
            $('.btnRegistrarTarea').on('click', function () {
                modal.style.display = 'block'
            });

            //boton de cerrar modal tarea
            cerrarmodal.addEventListener('click',()=>{
                limpiar_campos_tarea();
                modal.style.display = 'none';
              });

            //boton de guardar modal tarea
            guardarmodal.addEventListener('click',()=>{
                var horaInicioValueTarea = horaInicioInputTarea.value;
                var horaFinValueTarea = horaFinInputTarea.value;

                if (horaInicioValueTarea && horaFinValueTarea) {


                    var horaIniciotarea = new Date(horaInicioValueTarea);
                    horaInicioFinalTarea = horaIniciotarea.getFullYear() + "-" +
                    ("0" + (horaIniciotarea.getMonth() + 1)).slice(-2) + "-" +
                    ("0" + horaIniciotarea.getDate()).slice(-2) + " " +
                    ("0" + horaIniciotarea.getHours()).slice(-2) + ":" +
                    ("0" + horaIniciotarea.getMinutes()).slice(-2) + ":00";
                    var horaFintarea = new Date(horaFinValueTarea);
                    horaFinFinalTarea = horaFintarea.getFullYear() + "-" +
                    ("0" + (horaFintarea.getMonth() + 1)).slice(-2) + "-" +
                    ("0" + horaFintarea.getDate()).slice(-2) + " " +
                    ("0" + horaFintarea.getHours()).slice(-2) + ":" +
                    ("0" + horaFintarea.getMinutes()).slice(-2) + ":00";

                    if (horaFintarea <= horaIniciotarea) {
                        $.alert({
                            title: 'Alerta!',
                            content: 'La hora de fin debe ser mayor que la hora de inicio.',
                        });

                    } else {
                        //validar que tenga cargado un id_solicitante
                        if ($('select[name="id_responsable_tarea"]').val() == "" ){

                            $.alert({
                                title: 'Alerta!',
                                content: 'Debe seleccionar un responsable.',
                            });
                        }
                        else {
                            //procedemos a capturar todos los datos de los campos
                            inicio= horaInicioFinalTarea 
                            vencimiento= horaFinFinalTarea
                            respons= document.getElementById('id_id_responsable_tarea');
                            responsable= respons.options[respons.selectedIndex].text;
                            responsable_id = $('select[name="id_responsable_tarea"]').val();
                            tip_tar= document.getElementById('id_id_tipo_tarea'); 
                            tipo_tarea= tip_tar.options[tip_tar.selectedIndex].text;
                            id_tipo_tarea= $('select[name="id_tipo_tarea"]').val();
                            estad= document.getElementById('id_id_estado_tarea'); 
                            estado= estad.options[estad.selectedIndex].text; 
                            id_estado = $('select[name="id_estado_tarea"]').val();
                            observacion= $('textarea[name="observacion_tarea"]').val();

                            tareas= {'inicio': inicio, 'vencimiento': vencimiento, 'responsable': responsable + '|' + responsable_id , 'tipo_tarea': tipo_tarea + '|' + id_tipo_tarea , 'estado': estado + '|' + id_estado, 'observacion': observacion}
                            //agregamos en la tabla de tareas
                            //primero validamos 
                            var validar= actividad_academica.verificar_tarea(tareas)
                            if (validar == true ) {
                                actividad_academica.addtarea(tareas)
                            } else {
                                $.alert({
                                    title: 'Alerta!',
                                    content: 'La tarea ya se encuentra en la lista!',
                                });

                            }
                            
                            

                            //limpiamos los campos completados
                            limpiar_campos_tarea();
                            //cerramos el modal y actualizamos el tb de tareas
                            modal.style.display = 'none';
                        }
                    }
                    
                } else {
                    $.alert({
                        title: 'Alerta!',
                        content: 'Los campos de hora inicio y fin deben estar cargados.',
                    });
                }
            });
            
            //boton 2 de cerrar modal tarea
            cerrarmodal2.addEventListener('click',()=>{
                limpiar_campos_tarea();
                modal.style.display = 'none';
            });

            function limpiar_campos_tarea(){
                //inicio y fin 
                horaInicioInputTarea.value= ''
                horaFinInputTarea.value= ''
                //responsalbe
                $('select[name="id_responsable_tarea"]').val(null).trigger('change');;
                //observacion
                $('textarea[name="observacion_tarea"]').val('');
            }

            //debemos capturar todos los valores de los campos de la tabla de tareas y volver a asignar a la lista tareas dentro del table para poder enviar
            function capturar_tareas() {

                lista_tareas= []

                //validamos que la lista tenga tareas antes de capturar los datos de las columnas
                if (actividad_academica.items.tareas.length > 0) {

                    $('#tblTareas tbody tr').each(function() {
                        var col1Value = $(this).find('text[name="InicioTarea"]').attr('value');
                        var col2Value = $(this).find('text[name="FinTarea"]').attr('value');
                        var col3Value = $(this).find('text[name="ResponsalbeTarea"]').attr('value');
                        var col4Value = $(this).find('text[name="TipoTarea"]').attr('value');
                        var col5Value = $(this).find('text[name="EstadoTarea"]').attr('value');
                        var col6Value = $(this).find('text[name="Observacion"]').attr('value');

                        //insertamos en la lista para devolver
                        lista_tareas.push({'inicio': col1Value, 'vencimiento': col2Value, 'responsable': col3Value, 'tipo_tarea': col4Value, 'estado': col5Value, 'observacion': col6Value})
                    });
                }

                return lista_tareas
            }


            function limpiar_campos_tipo_orientacion(){
                $('textarea[name="descripcion_tipo_orientacion"]').val('');
            }
    
            add_orientacion.addEventListener("click", function(event) {
                event.preventDefault();  // Evita el comportamiento predeterminado del enlace
                modalAddTipoOrientacion.style.display = 'block'
            });
    
    
            //boton 2 de cerrar modal tipo orientacion
            cerrarAddtipoOrientacion1.addEventListener('click',()=>{
                limpiar_campos_tipo_orientacion();
                modalAddTipoOrientacion.style.display = 'none';
            });
    
    
            //boton 2 de cerrar modal tipo orientacion
            cerrarAddtipoOrientacion2.addEventListener('click',()=>{
                limpiar_campos_tipo_orientacion();
                modalAddTipoOrientacion.style.display = 'none';
            });
    
    
            //boton de guardar modal tipo orientacion
            guardarTipoOrientacion.addEventListener('click',()=>{
                alert_action('Notificación', '¿Estas seguro de agregar el tipo de orientación académica?', function () {
                    //validar que tenga cargado una observacion
                    if ( $('textarea[name="descripcion_tipo_orientacion"]').val() == "" ){
    
                        $.alert({
                            title: 'Alerta!',
                            content: 'Debe cargase una descripción.',
                        });
                    } else {
                        //procedemos a capturar todos los datos de los campos
                        descripcion= $('textarea[name="descripcion_tipo_orientacion"]').val();
    
                        $.ajax({
                            url: '/actualizar_campo/',
                            type: 'POST',
                            data: {
                                'accion': 'add_tipo_orientacion',
                                'descripcion': descripcion
                            },
                            dataType: 'json',
                        }).done(function (data) {
                            if (data[0].estado == 'existe'){
                                $.alert({
                                    title: 'Alerta!',
                                    content: 'Ya existe un registro con la misma descripción.',
                                });
                            } else{
    
                                //limpiamos los campos completados
                                limpiar_campos_tipo_orientacion();
                                //cerramos el modal y actualizamos el select de tipo tutoria
                                modalAddTipoOrientacion.style.display = 'none';
                                actualizartipo_ori_academ();
                            }
                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            alert(textStatus + ': ' + errorThrown);
                        }).always(function (data) {
    
                        });                        
                    }
                });
            });
    
    
            function limpiar_campos_motivo(){
                $('textarea[name="descripcion_Motivo"]').val('');
            }
    
            add_motivo.addEventListener("click", function(event) {
                event.preventDefault();  // Evita el comportamiento predeterminado del enlace
                modalAddMotivo.style.display = 'block'
            });
    
    
            //boton 2 de cerrar modal tipo orientacion
            cerrarMotivo1.addEventListener('click',()=>{
                limpiar_campos_motivo();
                modalAddMotivo.style.display = 'none';
            });
    
    
            //boton 2 de cerrar modal tipo orientacion
            cerrarMotivo2.addEventListener('click',()=>{
                limpiar_campos_motivo();
                modalAddMotivo.style.display = 'none';
            });
    
    
            //boton de guardar modal tipo orientacion
            guardarMotivo.addEventListener('click',()=>{
                alert_action('Notificación', '¿Estas seguro de agregar el motivo de orientación académica?', function () {
                    //validar que tenga cargado una observacion
                    if ( $('textarea[name="descripcion_Motivo"]').val() == "" ){
    
                        $.alert({
                            title: 'Alerta!',
                            content: 'Debe cargase una descripción.',
                        });
                    } else if ($('select[name="id_tipo_orientacion_academica_add"]').val() == ""){
    
                        $.alert({
                            title: 'Alerta!',
                            content: 'Debe seleccionar un tipo de orientación académica.',
                        });
                    }
                    else {
                        //procedemos a capturar todos los datos de los campos
                        descripcion= $('textarea[name="descripcion_Motivo"]').val();
                        id_tipo= $('select[name="id_tipo_orientacion_academica_add"]').val()
    
                        $.ajax({
                            url: '/actualizar_campo/',
                            type: 'POST',
                            data: {
                                'accion': 'add_motivo',
                                'descripcion': descripcion,
                                'id_tipo': id_tipo
                            },
                            dataType: 'json',
                        }).done(function (data) {
                            if (data[0].estado == 'existe'){
                                $.alert({
                                    title: 'Alerta!',
                                    content: 'Ya existe un registro con la misma descripción para el tipo de orientación académica seleccionada.',
                                });
                            } else{
    
                                //limpiamos los campos completados
                                limpiar_campos_motivo();
                                //cerramos el modal y actualizamos el select de tipo tutoria
                                modalAddMotivo.style.display = 'none';
                                actualizartipo_motivo_ori_academ();
                            }
                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            alert(textStatus + ': ' + errorThrown);
                        }).always(function (data) {
    
                        });                        
                    }
                });
            });

        });

        if (lista_participantes.length === 0){
            actividad_academica.list();
        }
        else {

            actividad_academica.actualizar_participantes(lista_participantes)
        }

    </script>


{% endblock extrascripts %}
